# SPDX-FileCopyrightText: 2022 Maxwell G <gotmax@e.email>
# SPDX-License-Identifier: GPL-2.0-or-later

---
image: fedora/rawhide
packages:
  - python3
  - python3-dnf
  - fedora-repos-rawhide
  # Needed to build the test packages
  - rpm-build
  - createrepo_c
  #
  - scdoc
  - pandoc
  - hut
secrets:
  - 759db354-8651-427c-b00a-0755164c8cae
oauth: pages.sr.ht/PAGES:RW
sources:
  - https://git.sr.ht/~gotmax23/fedrq
tasks:
  - copr-webhook: |
      cd fedrq/
      if ! [ -x "${HOME}/.copr-hook" ]
      then
        echo "Not submitting copr build. Secrets are disbaled."
        exit
      fi
      if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]
      then
        echo "Not submitting copr-build. Branch is not main."
        exit
      fi
      ~/.copr-hook
  - submit-man: |
      cd fedrq
      set +x
      if [ -z "${OAUTH2_TOKEN-}" ]
      then
        echo "Not submitting manpage build. Secrets are disabled"
        exit
      fi
      set -x
      if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]
      then
        echo "Not submitting manpage build. Branch is not main."
        exit
      fi

      cd doc
      scdoc < fedrq.1.scd | pandoc -f man -o fedrq.1.html
      # TODO: Write fedrq(5)
      # scdoc < fedrq.5.scdoc | pandoc -f man -o fedrq.5.html
      tar czvf fedrq.tar.gz *.html
      hut pages publish fedrq.tar.gz -d gotmax23.srht.site -s fedrq
  - lint: |
      cd fedrq
      venv="$(mktemp -d)"
      python3 -m venv "${venv}"  --system-site-packages
      source "${venv}/bin/activate"
      pip3 install '.[lint]'
      ./lint.sh --check
  - pytest: |
      cd fedrq
      venv="$(mktemp -d)"
      python3 -m venv "${venv}"  --system-site-packages
      source "${venv}/bin/activate"
      pip3 install '.[test]'
      pytest
