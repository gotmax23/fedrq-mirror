# SPDX-FileCopyrightText: 2022 Maxwell G <gotmax@e.email>
# SPDX-License-Identifier: GPL-2.0-or-later

---
image: fedora/36
packages:
  - createrepo_c
  - fedpkg
  - mock
  - mock-core-configs
  - rpmautospec
  - rpmdevtools
  - shadow-utils
  # fclogr dependency
  - python3-specfile
sources:
  - https://git.sr.ht/~gotmax23/fedrq
environment:
  RELEASE: f36
artifacts:
  - fedrq/results_fedrq.tar.gz
tasks:
  - setup-add-mock-group: |
      sudo usermod -aG mock $USER
  - setup-venv: |
      python3 -m venv ~/venv --system-site-packages
      . ./venv/bin/activate
      cd fedrq
      pip3 install '.[dev]' fclogr
  - build-f36: |
      . ./venv/bin/activate
      cd fedrq
      fclogr --debug dev-entries --archive -r $(git describe --abbrev=0 HEAD)
      fedpkg --name fedrq --release "${RELEASE}" mockbuild --no-cleanup-after -- --verbose|| r=$?
      tar cvf results_fedrq.tar.gz results_fedrq
      exit $r
  - test-py310: |
      . ./venv/bin/activate
      cd fedrq
      pytest -v
      mypy src/fedrq/
