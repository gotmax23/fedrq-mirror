# SPDX-FileCopyrightText: 2022 Maxwell G <gotmax@e.email>
# SPDX-License-Identifier: GPL-2.0-or-later

---
image: fedora/rawhide
packages:
  - python3
  - python3-dnf
  - fedora-repos-rawhide
  # Needed to build the test packages
  - rpm-build
  - createrepo_c
secrets:
  - 759db354-8651-427c-b00a-0755164c8cae
sources:
  - https://git.sr.ht/~gotmax23/fedrq
tasks:
  - copr-webhook: |
      cd fedrq/
      if ! [ -x "${HOME}/.copr-hook" ]
      then
        echo "Not submitting copr build. Secrets are disbaled."
        exit
      fi
      if ! [ "$(git rev-parse HEAD)" = "$(git rev-parse origin/main)" ]
      then
        echo "Not submitting copr-build. Branch is not main."
        exit
      fi
      ~/.copr-hook
  - lint: |
      cd fedrq
      venv="$(mktemp -d)"
      python3 -m venv "${venv}"  --system-site-packages
      source "${venv}/bin/activate"
      pip3 install '.[lint]'
      ./lint.sh --check
  - pytest: |
      cd fedrq
      venv="$(mktemp -d)"
      python3 -m venv "${venv}"  --system-site-packages
      source "${venv}/bin/activate"
      pip3 install '.[test]'
      pytest
